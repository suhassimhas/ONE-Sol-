# Contractor Jobs Feature - Visual Flow & Usage Guide

## User Interface Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CONTRACTOR DASHBOARD                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Performance Metrics] [Active Contracts] [Earnings]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ğŸ” SEARCH JOBS BY CATEGORY                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚  What category do you work in?                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ e.g., Plumbing, Carpentry, Electrical... â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                     [ğŸ” SEARCH]                  â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  AVAILABLE PROJECTS BOARD                               â”‚
â”‚  [Recommended] [All Projects] [N8N Jobs(5)]             â”‚
â”‚                                                           â”‚
â”‚  When "N8N Jobs" tab is clicked:                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Emergency Pipe Repair          [View Details]    â”‚  â”‚
â”‚  â”‚ Description: Urgent plumbing repair needed       â”‚  â”‚
â”‚  â”‚ Budget: $500 | Deadline: 2025-11-16             â”‚  â”‚
â”‚  â”‚ Category: Plumbing                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Roof Leak Assessment           [View Details]    â”‚  â”‚
â”‚  â”‚ Description: Water damage assessment...          â”‚  â”‚
â”‚  â”‚ Budget: $300 | Deadline: 2025-11-20             â”‚  â”‚
â”‚  â”‚ Category: Roofing                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
FRONTEND (React)
â”‚
â”œâ”€ Contractor enters category: "Plumbing"
â”‚
â”œâ”€ Calls: apiService.searchContractorJobs("Plumbing")
â”‚         (POST request with JWT token)
â”‚
â–¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BACKEND (Express.js)
â”‚
â”œâ”€ Route: POST /api/contractor-jobs/search
â”‚
â”œâ”€ Middleware:
â”‚  â”œâ”€ authMiddleware (validates JWT)
â”‚  â”œâ”€ requireRole('contractor') (checks user role)
â”‚
â”œâ”€ Route Handler:
â”‚  â”œâ”€ Validates category input
â”‚  â”‚
â”‚  â”œâ”€ Calls axios.post() to n8n webhook:
â”‚  â”‚  URL: https://uncharitable-unparenthesized-shaunta.ngrok-free.dev/webhook-test/contractor-jobs
â”‚  â”‚  Body: { category: "Plumbing" }
â”‚  â”‚
â”‚  â”œâ”€ Catches response or error
â”‚  â”‚
â”‚  â”œâ”€ Returns JSON to frontend:
â”‚  â”‚  {
â”‚  â”‚    "success": true,
â”‚  â”‚    "jobs": [...]
â”‚  â”‚  }
â”‚
â–¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

N8N WEBHOOK
â”‚
â”œâ”€ Receives: { category: "Plumbing" }
â”‚
â”œâ”€ Processing:
â”‚  â”œâ”€ Query database/service for matching jobs
â”‚  â”œâ”€ Filter by category
â”‚  â”œâ”€ Apply any business logic
â”‚
â”œâ”€ Returns JSON array of jobs with metadata:
â”‚  [
â”‚    {
â”‚      "title": "Emergency Pipe Repair",
â”‚      "description": "Urgent plumbing repair needed",
â”‚      "budget": 500,
â”‚      "deadline": "2025-11-16",
â”‚      "category": "Plumbing",
â”‚      ... (any other fields)
â”‚    }
â”‚  ]
â”‚
â–¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FRONTEND (React) - Display Results
â”‚
â”œâ”€ Receives jobs array from backend
â”‚
â”œâ”€ Switches to "N8N Jobs" tab
â”‚
â”œâ”€ Maps through jobs array and renders each job:
â”‚  â”œâ”€ Title
â”‚  â”œâ”€ Description
â”‚  â”œâ”€ Budget
â”‚  â”œâ”€ Deadline
â”‚  â”œâ”€ All other fields (dynamic display)
â”‚  â”œâ”€ "View Details" button
â”‚
â”œâ”€ Shows toast: "Found 5 job(s) in Plumbing"
â”‚
â–¼

USER SEES: List of available N8N jobs for their category
```

---

## Component Hierarchy

```
ContractorDashboard
â”‚
â”œâ”€ MainDashboard
â”‚  â”‚
â”‚  â”œâ”€ Grid: Performance Cards
â”‚  â”‚  â”œâ”€ AI Performance Score
â”‚  â”‚  â”œâ”€ Active Contracts
â”‚  â”‚  â””â”€ Total Earnings
â”‚  â”‚
â”‚  â”œâ”€ CategorySearch âœ¨ NEW
â”‚  â”‚  â”œâ”€ Text input for category
â”‚  â”‚  â”œâ”€ Search button
â”‚  â”‚  â””â”€ Calls onJobsFound callback
â”‚  â”‚
â”‚  â””â”€ AvailableProjects (Enhanced)
â”‚     â”œâ”€ Filter tabs: [Recommended] [All] [N8N Jobs]
â”‚     â”œâ”€ Regular projects (from local storage)
â”‚     â””â”€ N8N jobs (from webhook response)
â”‚
â”œâ”€ ProjectDetails
â”‚  â”œâ”€ Problem details
â”‚  â””â”€ Bid submission form
â”‚
â””â”€ MyBids
   â”œâ”€ User's submitted bids
   â””â”€ AI evaluation scores
```

---

## State Management

```
ContractorDashboard (Parent)
â”‚
â”œâ”€ State: selectedProject
â”‚  â””â”€ Used to show ProjectDetails view
â”‚
â””â”€ State: n8nJobs âœ¨ NEW
   â”œâ”€ Stores array of jobs from n8n webhook
   â”œâ”€ Updated by CategorySearch component
   â””â”€ Passed to AvailableProjects component
      
AvailableProjects
â”‚
â”œâ”€ State: allProjects (from local storage)
â”œâ”€ State: n8nJobs (from parent prop)
â”œâ”€ State: filteredProjects (based on filter)
â”œâ”€ State: filter ('recommended' | 'all' | 'n8n')
â””â”€ State: loading
```

---

## Step-by-Step Usage Example

### Scenario: Contractor looking for plumbing jobs

**Step 1:** Contractor logs in and sees dashboard
```
âœ“ Dashboard loads
âœ“ Sees "Search Jobs by Category" form
âœ“ Sees existing available projects
```

**Step 2:** Contractor enters their category
```
Input: "Plumbing"
```

**Step 3:** Contractor clicks Search
```
âœ“ Button shows loading spinner
âœ“ Frontend sends: POST /api/contractor-jobs/search
âœ“ Body: { "category": "Plumbing" }
âœ“ Headers: Authorization: Bearer <token>
```

**Step 4:** Backend processes request
```
âœ“ Validates authentication
âœ“ Validates category input
âœ“ Calls n8n webhook with category
âœ“ Receives response from n8n
âœ“ Returns to frontend: { success: true, jobs: [...] }
```

**Step 5:** Frontend displays results
```
âœ“ Updates n8nJobs state
âœ“ Shows toast: "Found 5 job(s) in Plumbing"
âœ“ Automatically switches to "N8N Jobs" tab
âœ“ Displays jobs with all metadata
âœ“ Shows "N8N Jobs (5)" in tab
```

**Step 6:** Contractor views job details
```
âœ“ Clicks "View Details" on a job
âœ“ Toast shows: "This is an N8N job. You can contact the provider..."
```

---

## Error Handling Scenarios

### Scenario 1: Empty Category Input
```
User Input: "" (empty or whitespace)
â†“
Frontend Validation: "Please enter a category"
â†“
Toast Error: "Please enter a category"
```

### Scenario 2: N8N Webhook Unreachable
```
Request to n8n webhook fails
â†“
Backend catches error
â†“
Returns: {
  "success": false,
  "error": "Failed to fetch jobs from n8n"
}
â†“
Frontend shows error toast
â†“
onJobsFound([]) called - clears any previous jobs
```

### Scenario 3: Unauthenticated User
```
No valid JWT token
â†“
Backend authMiddleware rejects request
â†“
Returns: 401 Unauthorized
â†“
Frontend shows auth error
```

### Scenario 4: Non-Contractor User
```
User role is not 'contractor'
â†“
Backend requireRole('contractor') fails
â†“
Returns: 403 Forbidden
â†“
Frontend shows permission error
```

---

## Job Display Format

Each job card displays:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ”µ N8N] Job Title                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Description text here...                        â”‚
â”‚                                                  â”‚
â”‚ $ Budget: $500    â± Deadline: 2025-11-16      â”‚
â”‚ Category: Plumbing                             â”‚
â”‚                                                  â”‚
â”‚ [Dynamic Fields]                                â”‚
â”‚ â€¢ field1: value1                                â”‚
â”‚ â€¢ field2: value2                                â”‚
â”‚ â€¢ field3: value3                                â”‚
â”‚                      [View Details]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuration

### N8N Webhook URL
```
WEBHOOK_URL = "https://uncharitable-unparenthesized-shaunta.ngrok-free.dev/webhook-test/contractor-jobs"
```

**Location:** `backend/src/routes/contractorJobs.ts` (Line 20)

**Note:** To change the webhook URL, modify the `N8N_WEBHOOK_URL` constant in the route file.

---

## Response Format Examples

### N8N Returns Multiple Jobs
```json
[
  {
    "title": "Emergency Pipe Repair",
    "description": "Urgent plumbing repair needed",
    "budget": 500,
    "deadline": "2025-11-16",
    "category": "Plumbing",
    "priority": "high",
    "location": "Downtown"
  },
  {
    "title": "Drain Cleaning",
    "description": "Main line cleaning",
    "budget": 200,
    "deadline": "2025-11-17",
    "category": "Plumbing",
    "priority": "medium"
  }
]
```

### N8N Returns Custom Fields
```json
[
  {
    "jobId": "PLM-001",
    "title": "Fixture Installation",
    "client": "John Smith",
    "address": "123 Main St",
    "estimatedHours": 3,
    "toolsRequired": ["wrench", "caulk", "tape"],
    "notes": "New bathroom sink installation"
  }
]
```

### Frontend Displays Dynamically
```
All fields are shown automatically, including custom ones.
Special fields like "title", "description", "budget", 
"deadline" are displayed prominently.
All other fields are shown as a list below.
```

---

## Testing the Feature

### Manual Testing Steps

1. **Login as Contractor**
   - Navigate to contractor dashboard
   
2. **Test Valid Search**
   - Enter "Plumbing" in category field
   - Click Search
   - Verify jobs appear in N8N Jobs tab
   
3. **Test Empty Input**
   - Leave category field empty
   - Click Search
   - Verify error message appears
   
4. **Test Multiple Searches**
   - Search for "Carpentry"
   - Verify previous results are replaced
   - Switch back to "Recommended" tab
   - Verify regular projects still show
   
5. **Test Non-Contractor Access**
   - Login as non-contractor user
   - Verify endpoint returns 403 error
   
6. **Test Invalid Category**
   - Enter special characters or very long string
   - Verify backend handles gracefully

---

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| "Jobs not showing" | N8N webhook not returning data | Check n8n webhook URL and ensure it's running |
| "401 Unauthorized" | Invalid or expired JWT token | Login again to get new token |
| "403 Forbidden" | User role is not 'contractor' | Login with a contractor account |
| "Network error" | Backend not running | Start backend: `npm run dev` |
| "Empty results" | N8N returned empty array | N8N webhook may have no matching jobs |

